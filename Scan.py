import hashlib
import sys
import vt
import time
import requests
import json
from os import listdir
from os.path import isfile, join


def file_as_bytes(file):
    with file:
        return file.read()


def hash_file(full_path):
    print(full_path)
    try:
        md5_val = hashlib.md5(file_as_bytes(
            open(full_path, 'rb'))).hexdigest()
        return md5_val
    except FileNotFoundError:
        print(FileNotFoundError)
        return ""


def request_vt(hash):
    url = "https://www.virustotal.com/api/v3/files/" + str(hash)
    headers = {
        "X-Apikey": "c940b1397abe8c705da3404a58c88c4c7b31bbe88159733d3e63fc9fbe796eb6"}
    res = requests.get(url, headers=headers)
    res = json.loads(res.text)
    return res


def scan_file(path):
    result = {"is_safe": True,  "suspicious": 0,
              "harmless": 0, "undetected": 0, "notFound": False}
    hash = hash_file(path)
    if hash == "":
        print("FILE NOT FOUND")
    else:
        res = request_vt(hash)
        
    if "error" in res and res["error"]["code"] == "NotFoundError":
        result["notFound"] = True
        return result

    data = res["data"]["attributes"]["last_analysis_stats"]
    if data['malicious'] > 0:
        result["is_safe"] = False
        result["suspicious"] = data["suspicious"]
        result["undetected"] = data["undetected"]
        result["harmless"] = data["harmless"]

    return result


def scan_folder(path):
    onlyfiles = [f for f in listdir(path)
                 if isfile(join(path, f))]
    res = None
    file_path = ""
    malicious = []
    for file in onlyfiles:
        file_path = path + "/" + file
        res = scan_file(file_path)
        if res["is_safe"] == False:
            malicious.append(file)
    return malicious
